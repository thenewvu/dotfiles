#!/usr/bin/env bash
# https://www.reddit.com/r/archlinux/comments/5vusvx/here_is_my_bash_prompt_whats_your_favorite/de58buf/

function prompt_build {
    [[ -n "$COLUMNS" ]] || return

    local ret=$?
    local maxwidth=$(( COLUMNS / 3 ))
    local err

    local rprompt
    local id="${USER}@${HOSTNAME}"
    local path="${PWD//$HOME/\~}"
    local gstatus

    (( ret )) && err=$ret

    if [[ -x $(\which git) ]]; then
        gstatus=$(git symbolic-ref --quiet --short HEAD 2>/dev/null || \
                  git describe --tags --exact-match 2>/dev/null || \
              git rev-parse --short HEAD 2>/dev/null)
        [[ -n "$(git status --porcelain 2>/dev/null)" ]] && gstatus+="*"
    fi

    rprompt="${id}:${path}${gstatus:+ ($gstatus)}"
    [[ ${#rprompt} -ge ${maxwidth} ]] && rprompt="${id}:${path}"
    [[ ${#rprompt} -ge ${maxwidth} ]] && rprompt="${path}"

    while [[ ${#rprompt} -ge ${maxwidth} ]]; do
        rprompt=${rprompt#../}
        if [[ "${rprompt#*/}" == "${rprompt}" ]]; then
            rprompt=""
            break
        else
            rprompt="../${rprompt#*/}"
        fi
    done

    if [[ -n "${rprompt}" ]]; then
        \tput cuf $(( $COLUMNS - ${#rprompt} ))
        \printf '%s' "$rprompt"
        \tput cub ${COLUMNS}
    fi

    REPLY="${err+$err}\$ "
}

function bash_prompt {
    printf '%*s\n' "${COLUMNS:-$(tput cols)}" '' | tr ' ' '-'
    prompt_build
    PS1="$REPLY"
}

export PROMPT_COMMAND="bash_prompt"
export PS1=$'\001\r''${|prompt_build}'
